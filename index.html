<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ã‚®ã‚¿ãƒ¼ï¼ãƒ™ãƒ¼ã‚¹ãƒ”ã‚¢ãƒå¤‰æ›ã‚µã‚¤ãƒˆ</title>

<style>
:root{
  --bg0:#050505;
  --bg1:#0b0b0b;
  --panel: rgba(10,10,10,.62);
  --shadow: 0 12px 34px rgba(0,0,0,.58);
  --glow: 0 0 10px rgba(255,255,255,.40), 0 0 22px rgba(255,255,255,.22);
  --glowStrong: 0 0 12px rgba(255,255,255,.72), 0 0 34px rgba(255,255,255,.36);

  /* board (PC default) */
  --cellW: 40px;
  --cellH: 34px;
  --fretW: 46px;
  --spacerH: 34px;

  /* piano width */
  --pW: 190px;

  --radius: 18px;
}

*{ box-sizing:border-box; }
html, body{ height:100%; }
body{
  margin:0;
  color:#f4f4f4;
  font-family: system-ui, "Segoe UI", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
  background:
    radial-gradient(1100px 520px at 65% 18%, rgba(255,255,255,.10), transparent 62%),
    radial-gradient(900px 680px at 25% 72%, rgba(255,255,255,.06), transparent 60%),
    linear-gradient(90deg, var(--bg0), var(--bg1) 55%, rgba(255,255,255,.06) 100%);
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background:
    repeating-linear-gradient(0deg, rgba(255,255,255,.03) 0 1px, transparent 1px 4px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.02) 0 1px, transparent 1px 4px);
  mix-blend-mode: overlay;
  opacity:.22;
}

.wrap{ max-width: 1500px; margin:0 auto; padding: 12px; }

/* ===== Header / Controls ===== */
.topbar{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
h1{
  margin:0;
  font-size:22px;
  font-weight:1000;
  letter-spacing:.6px;
  text-shadow: var(--glow);
}
.sub{
  margin-top:4px;
  color: rgba(255,255,255,.75);
  font-weight:800;
  font-size:12px;
}

.controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
select, .btn, input{
  border:1px solid rgba(255,255,255,.30);
  background: rgba(10,10,10,.55);
  color:#fff;
  padding:10px 12px;
  border-radius:14px;
  font-weight:1000;
  font-size:14px;
  cursor:pointer;
  transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
  outline:none;
  touch-action: manipulation;
}
input{ cursor:text; }
select:hover, .btn:hover, input:hover{
  border-color: rgba(255,255,255,.58);
  box-shadow: var(--glow);
}
.btn:active{ transform: translateY(1px); }
.btn.primary{
  background: rgba(255,255,255,.12);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);
}

/* ===== Panels / PC layout ===== */
.main{
  display:flex;
  gap:12px;
  align-items:flex-start;
}
.panel{
  border-radius:var(--radius);
  background: var(--panel);
  border:1px solid rgba(255,255,255,.20);
  box-shadow: var(--shadow);
  overflow:hidden;
  backdrop-filter: blur(8px);
}
.panel-title{
  padding:10px 12px;
  font-weight:1000;
  letter-spacing:.3px;
  font-size:15px;
  border-bottom: 1px solid rgba(255,255,255,.14);
  background: linear-gradient(90deg, rgba(255,255,255,.10), rgba(0,0,0,0));
}
.panel-body{ padding:12px; }

.left{
  flex: 1 1 auto;
  min-width: 760px;
}
.right{
  flex: 0 0 520px;
  min-width: 520px;
  max-width: 640px;
}

/* ===== Fretboard ===== */
.fret-piano{ display:flex; gap:12px; align-items:flex-start; }
.fret-piano > div:first-child{ flex: 1 1 auto; min-width: 0; }

.strings-row{
  display:grid;
  grid-template-columns: var(--fretW) repeat(6, var(--cellW));
  align-items:stretch;
  margin-bottom:8px;
}
.slabwrap{
  border:1px solid rgba(255,255,255,.14);
  border-radius:12px;
  background: rgba(0,0,0,.35);
  padding:6px 0 7px 0;
  text-align:center;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
}
.openname{
  font-weight:1000;
  font-size:12px;
  color: rgba(255,255,255,.92);
  line-height:1;
  text-shadow: 0 0 10px rgba(255,255,255,.15);
}
.slab{
  margin-top:4px;
  font-weight:1000;
  font-size:14px;
  color: rgba(255,255,255,.92);
  line-height:1;
  text-shadow: 0 0 10px rgba(255,255,255,.22);
}
.slabwrap.disabled{ opacity:.25; }
.slabwrap.muted{ opacity:.40; background: rgba(255,255,255,.06); }
.slabwrap.mutedGlow{ opacity:.55; box-shadow: 0 0 18px rgba(255,255,255,.40); border-color: rgba(255,255,255,.40); }

/* scroll for board (PC) */
.scroll{
  max-height: 78vh;
  overflow:auto;
  padding-right:6px;
}
.scroll::-webkit-scrollbar{ width:10px; }
.scroll::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.22);
  border-radius:999px;
  border:2px solid rgba(0,0,0,.55);
}
.scroll::-webkit-scrollbar-track{ background: rgba(0,0,0,.35); border-radius:999px; }

.board{
  display:grid;
  grid-template-columns: var(--fretW) repeat(6, var(--cellW));
  grid-auto-rows: var(--cellH);
  border-radius:14px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.22);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -1px 0 rgba(0,0,0,.80),
    0 0 18px rgba(255,255,255,.08);
  background: rgba(0,0,0,.25);
}
.fret{
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:1000;
  font-size:14px;
  color: rgba(255,255,255,.92);
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.45));
  border-right:1px solid rgba(255,255,255,.18);
  border-bottom:1px solid rgba(255,255,255,.10);
  text-shadow: 0 0 10px rgba(255,255,255,.22);
}
.fret.openrow{ background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(0,0,0,.38)); }

.cell{
  cursor:pointer;
  user-select:none;
  position:relative;
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.42));
  border-right:1px solid rgba(255,255,255,.18);
  border-bottom:1px solid rgba(255,255,255,.10);
  transition: background .12s ease, box-shadow .12s ease;
  touch-action: manipulation;
}
.cell::before{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.18), inset 0 -1px 0 rgba(0,0,0,.75);
  opacity:.9;
}
.cell:hover{ background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.38)); }
.cell.selected{
  background: linear-gradient(180deg, rgba(255,255,255,.40), rgba(0,0,0,.25));
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.35), var(--glowStrong);
}
.cell.disabled{ opacity:.18; pointer-events:none; filter: grayscale(1); }
.cell.openrow{ background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(0,0,0,.36)); }
.cell.openrow:hover{ background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(0,0,0,.34)); }
.cell.mutedcol{ opacity:.28; background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.50)); }

.spacer{
  height: var(--spacerH);
  background: rgba(255,255,255,.04);
  border-bottom:1px solid rgba(255,255,255,.10);
}
.spacer.left{ border-right:1px solid rgba(255,255,255,.18); }

@keyframes pulseGlow{
  0%   { box-shadow: inset 0 0 0 2px rgba(255,255,255,.20), 0 0 0 rgba(255,255,255,0); }
  40%  { box-shadow: inset 0 0 0 2px rgba(255,255,255,.62), 0 0 30px rgba(255,255,255,.45); }
  100% { box-shadow: inset 0 0 0 2px rgba(255,255,255,.35), 0 0 18px rgba(255,255,255,.22); }
}
.cell.pulse{ animation: pulseGlow .45s ease-out; }

.cell .posmark{
  position:absolute;
  width:9px; height:9px;
  border-radius:50%;
  background: rgba(255,255,255,.95);
  right:7px;
  top:7px;
  box-shadow: var(--glow);
}
.cell.double::after{
  content:"";
  position:absolute;
  width:9px; height:9px;
  border-radius:50%;
  background: rgba(255,255,255,.95);
  right:20px;
  top:7px;
  box-shadow: var(--glow);
}

/* ===== Piano (silent highlight) ===== */
.piano{
  width:var(--pW);
  position:relative;
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.22);
  border-radius:16px;
  overflow:hidden;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.12), 0 0 24px rgba(255,255,255,.06);
}
.key-white{
  position:absolute;
  left:0;
  width:100%;
  border-top:1px solid rgba(255,255,255,.16);
  display:flex;
  align-items:center;
  justify-content:flex-end;
  padding-right:8px;
  font-weight:1000;
  font-size:12px;
  color: rgba(255,255,255,.90);
  background: rgba(255,255,255,.06);
}
.key-black{
  position:absolute;
  left:0;
  background: rgba(0,0,0,.96);
  border:1px solid rgba(255,255,255,.34);
  border-radius:6px;
  z-index:3;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  padding-right:6px;
  font-weight:1000;
  font-size:11px;
  color: rgba(255,255,255,.96);
  box-shadow: 0 2px 14px rgba(0,0,0,.75);
}
.key-white.active{
  background: rgba(255,255,255,.22);
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.25), var(--glow);
}
.key-black.active{
  background: rgba(255,255,255,.78);
  color:#111;
  border-color: rgba(255,255,255,.72);
  box-shadow: var(--glowStrong);
}

/* ===== Chords (PC right) ===== */
.chordlist{ max-height: 74vh; overflow:auto; padding-right:6px; }
.chordgrid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
.cbtn{
  border:1px solid rgba(255,255,255,.20);
  background: rgba(0,0,0,.35);
  color:#fff;
  padding:10px 8px;
  border-radius:14px;
  font-weight:1000;
  font-size:14px;
  cursor:pointer;
  transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
  touch-action: manipulation;
}
.cbtn:hover{ border-color: rgba(255,255,255,.55); box-shadow: var(--glow); }
.cbtn:active{ transform: translateY(1px); }

.badge{
  display:inline-block;
  margin-left:6px;
  font-size:12px;
  font-weight:1000;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.28);
  background: rgba(255,255,255,.08);
}
.badge.ok{ box-shadow: 0 0 14px rgba(255,255,255,.35); }
.badge.ng{ opacity:.7; }

/* =========================
   âœ… äºŒé‡è¡¨ç¤ºã‚’æ ¹çµ¶ï¼šå¹…ã ã‘ã§å‡ºã—åˆ†ã‘
   ========================= */

/* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆPCï¼‰ */
.mobileWrap{ display:none; }

/* 900pxä»¥ä¸‹ï¼šãƒ¢ãƒã‚¤ãƒ«UI */
@media (max-width: 900px){
  .main{ display:none; }

  .mobileWrap{
    display:grid;
    grid-template-columns: 156px 1fr var(--pW);
    gap: 10px;
    align-items:start;
  }

  :root{
    --cellW: 34px;
    --cellH: 32px;
    --fretW: 38px;
    --spacerH: 26px;
    --pW: 92px;
  }

  /* smaller controls but still tappable */
  select, .btn, input{ font-size: 14px; padding: 10px 10px; border-radius: 14px; }

  .mPanelTitle{
    padding: 10px 10px;
    font-weight:1000;
    font-size:13px;
    border-bottom: 1px solid rgba(255,255,255,.14);
    background: linear-gradient(90deg, rgba(255,255,255,.10), rgba(0,0,0,0));
  }
  .mPanelBody{ padding: 10px; }

  .mChords .mPanelBody{ padding: 8px; }
  .mChords input{ width:100%; padding:10px; font-size:13px; }
  .mChords select{ width:100%; padding:10px; font-size:13px; }

  /* âœ… ã‚¹ãƒãƒ›ï¼šã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚’ã‚‚ã£ã¨å°ã•ã */
  .mChordList{
    margin-top: 8px;
    height: calc(100vh - 230px);
    overflow:auto;
    padding-right:6px;
  }
  .mChordGrid{
    display:grid;
    grid-template-columns: 1fr;
    gap: 8px;
  }
  .mChordGrid .cbtn{
    padding: 10px 8px;
    font-size: 13px;
    border-radius: 14px;
  }

  /* board should not be crushed; let it scroll */
  .mBoard .scroll{
    max-height: calc(100vh - 210px);
  }

  .mPiano .piano{
    width: var(--pW);
    height: calc(100vh - 170px);
    min-height: 60vh;
  }
}

@media (max-width: 420px){
  :root{ --pW: 84px; }
  .mobileWrap{ grid-template-columns: 146px 1fr var(--pW); }
}

/* âœ… PCç”¨ */
@media (min-width: 901px){

  /* 1) å·¦å³ãƒ‘ãƒãƒ«ã‚’åŒã˜é«˜ã•ã«ã—ã¦ã€ç¸¦ã‚’ç”»é¢ã«ãƒ•ã‚£ãƒƒãƒˆ */
  .main{
    align-items: stretch;
    height: calc(100vh - 110px); /* 90ã€œ140pxã§èª¿æ•´ */
  }

  /* 2) panelã‚’ç¸¦Flexã«ã—ã¦ã€titleä»¥å¤–ã‚’å…¨ã¦â€œæ®‹ã‚Šé«˜ã•â€ã« */
  .panel{
    display: flex;
    flex-direction: column;
    min-height: 0;
  }
  .panel-body{
    flex: 1;
    min-height: 0;
  }

  /* 3) å·¦ï¼šæŒ‡æ¿+ãƒ”ã‚¢ãƒã‚’åŒã˜é«˜ã•ã§ä¸¦ã¹ã‚‹ */
  .fret-piano{
    height: 100%;
    align-items: stretch;
  }
  .fret-piano > div:first-child{
    height: 100%;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  #stringsRow{ flex: 0 0 auto; }

  #scrollArea{
    flex: 1;
    max-height: none;
    min-height: 0;
  }

  #piano{
    height: 100%;
    min-height: 0;
  }

  /* 4) å³ï¼ˆã‚³ãƒ¼ãƒ‰ä¸€è¦§ï¼‰ã‚‚åŒã˜é«˜ã•ã§å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
  .right .panel-body{
    display: flex;
    flex-direction: column;
    min-height: 0;
  }
  .right .chordlist{
    flex: 1;
    max-height: none;
    min-height: 0;
  }

  /* 5) ãƒãƒ©ãƒ³ã‚¹æœ€é©åŒ– */
  .right{ flex: 0 0 460px; min-width: 460px; }
  .left{  flex: 1 1 auto; min-width: 780px; }
}
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>ã‚®ã‚¿ãƒ¼ï¼ãƒ™ãƒ¼ã‚¹ãƒ”ã‚¢ãƒå¤‰æ›ã‚µã‚¤ãƒˆ</h1>
      <div class="sub">ã‚¯ãƒªãƒƒã‚¯å³å¤‰æ› / å…±æœ‰URLã§æŠ¼ã•ãˆæ–¹ãã®ã¾ã¾é€ã‚Œã‚‹</div>
    </div>

    <div class="controls">
      <select id="instSel" title="æ¥½å™¨">
        <option value="guitar">ã‚®ã‚¿ãƒ¼ï¼ˆ6å¼¦ï¼‰</option>
        <option value="bass4">ãƒ™ãƒ¼ã‚¹ï¼ˆ4å¼¦ï¼‰</option>
        <option value="bass5">ãƒ™ãƒ¼ã‚¹ï¼ˆ5å¼¦ï¼‰</option>
        <option value="bass6">ãƒ™ãƒ¼ã‚¹ï¼ˆ6å¼¦ï¼‰</option>
      </select>

      <select id="tuneSel" title="ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°">
        <option value="0">æ¨™æº–</option>
        <option value="-1">åŠéŸ³ä¸‹ã’</option>
        <option value="-2">å…¨éŸ³ä¸‹ã’</option>
      </select>

      <select id="capoSel" title="ä»®æƒ³ã‚«ãƒï¼ˆã‚®ã‚¿ãƒ¼ã®ã¿ï¼‰"></select>

      <select id="voicingSel" title="æŠ¼ã•ãˆæ–¹ï¼ˆä¸€èˆ¬çš„ï¼‰">
        <option value="open">OPENå„ªå…ˆ</option>
        <option value="barreE">Eãƒ•ã‚©ãƒ¼ãƒ å„ªå…ˆ</option>
        <option value="barreA">Aãƒ•ã‚©ãƒ¼ãƒ å„ªå…ˆ</option>
      </select>

      <select id="powerRootSel" title="ãƒ‘ãƒ¯ãƒ¼ã‚³ãƒ¼ãƒ‰(5) ãƒ«ãƒ¼ãƒˆå¼¦ï¼ˆã‚®ã‚¿ãƒ¼ï¼‰">
        <option value="auto">Power: è‡ªå‹•</option>
        <option value="6">Power: 6å¼¦ãƒ«ãƒ¼ãƒˆ</option>
        <option value="5">Power: 5å¼¦ãƒ«ãƒ¼ãƒˆ</option>
      </select>

      <select id="slashSel" title="ã‚ªãƒ³ã‚³ãƒ¼ãƒ‰ (ä¾‹: /E)">
        <option value="off">ã‚ªãƒ³ã‚³ãƒ¼ãƒ‰OFF</option>
        <option value="on">ã‚ªãƒ³ã‚³ãƒ¼ãƒ‰ON</option>
      </select>
      <select id="bassNoteSel" title="ã‚ªãƒ³ã‚³ãƒ¼ãƒ‰ã®ãƒ™ãƒ¼ã‚¹éŸ³" style="display:none;"></select>

      <select id="bassFollowSel" title="ãƒ™ãƒ¼ã‚¹ï¼šãƒ«ãƒ¼ãƒˆè¿½å¾“ã™ã‚‹å¼¦" style="display:none;"></select>

      <button class="btn primary" id="btnShare" type="button" title="URLã‚’ã‚³ãƒ”ãƒ¼">å…±æœ‰URL</button>
      <button class="btn" id="btnClear" type="button">ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <!-- PC layout -->
  <div class="main">
    <div class="panel left">
      <div class="panel-title">æŒ‡æ¿ï¼ˆ0ã€œ22 / ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ + ãƒ”ã‚¢ãƒãƒ­ãƒ¼ãƒ«ï¼ˆç„¡éŸ³ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰</div>
      <div class="panel-body fret-piano">
        <div>
          <div class="strings-row" id="stringsRow"></div>
          <div class="scroll" id="scrollArea">
            <div class="board" id="board"></div>
          </div>
        </div>
        <div class="piano" id="piano"></div>
      </div>
    </div>

    <div class="panel right">
      <div class="panel-title">ã‚³ãƒ¼ãƒ‰ä¸€è¦§ï¼ˆä¸€èˆ¬çš„ãªæŠ¼ã•ãˆæ–¹ã®ã¿ï¼‰</div>
      <div class="panel-body">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <input id="searchBox" placeholder="æ¤œç´¢ (ä¾‹: C5, C#dim, Bb7, C/E)" style="flex:1; min-width:220px;">
          <select id="qualitySel" title="çµã‚Šè¾¼ã¿"></select>
        </div>

        <div style="margin-top:10px; color:rgba(255,255,255,.88); font-weight:900; font-size:13px; line-height:1.35;">
          ãƒ»æŒ‡æ¿ã‚»ãƒ«ï¼šã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ› / åŒã˜å ´æ‰€ã‚¯ãƒªãƒƒã‚¯ã§<b>ãƒŸãƒ¥ãƒ¼ãƒˆ</b><br>
          ãƒ»ã‚³ãƒ¼ãƒ‰ï¼šã‚¯ãƒªãƒƒã‚¯ã§è‡ªå‹•å…¥åŠ› / ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤ï¼ˆãƒ™ãƒ¼ã‚¹ã¯<b>ãƒ«ãƒ¼ãƒˆã®ã¿</b>ï¼‰<br>
          ãƒ»å…±æœ‰ï¼šå³ä¸Šã€Œå…±æœ‰URLã€ã§çŠ¶æ…‹ã¤ãURLã‚³ãƒ”ãƒ¼
        </div>

        <div class="chordlist" style="margin-top:10px;">
          <div class="chordgrid" id="chordGrid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MOBILE layout (not fixed, 3 columns) -->
  <div class="mobileWrap">
    <div class="panel mChords">
      <div class="mPanelTitle">ã‚³ãƒ¼ãƒ‰</div>
      <div class="mPanelBody">
        <input id="searchBoxM" placeholder="æ¤œç´¢ (C, Am, C5, C/E)">
        <div style="height:8px;"></div>
        <select id="qualitySelM"></select>

        <div class="mChordList">
          <div class="mChordGrid" id="chordGridM"></div>
        </div>
      </div>
    </div>

    <div class="panel mBoard">
      <div class="mPanelTitle">æŒ‡æ¿ï¼ˆ0ã€œ22ï¼‰</div>
      <div class="mPanelBody">
        <div class="strings-row" id="stringsRowM"></div>
        <div class="scroll" id="scrollAreaM">
          <div class="board" id="boardM"></div>
        </div>
      </div>
    </div>

    <div class="panel mPiano">
      <div class="mPanelTitle">Piano</div>
      <div class="mPanelBody" style="padding:8px;">
        <div class="piano" id="pianoM"></div>
      </div>
    </div>
  </div>

</div>

<script>
/* ===================== CONFIG ===================== */
const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const BLACK_PCS = new Set([1,3,6,8,10]);
const FRETS = 22;

// range: include B0 for bass5/6
const MIN_MIDI = 23; // B0
const MAX_MIDI = 84; // C6

// Tunings (MIDI open strings)
const GUITAR_6 = {6:40,5:45,4:50,3:55,2:59,1:64};
const BASS_4   = {4:28,3:33,2:38,1:43};
const BASS_5   = {5:23,4:28,3:33,2:38,1:43};
const BASS_6   = {6:23,5:28,4:33,3:38,2:43,1:48};

const ALL_COLS = [6,5,4,3,2,1];

/* ===================== HELPERS ===================== */
const mod = (n,m)=>((n%m)+m)%m;
const isBlack = (m)=>BLACK_PCS.has(m%12);
const pcToName = (pc)=>NOTE_NAMES[mod(pc,12)];
const nameToPc = (name)=>NOTE_NAMES.indexOf(name);
const midiToName = (midi)=>{
  const n = NOTE_NAMES[midi%12];
  const oct = Math.floor(midi/12)-1;
  return `${n}${oct}`;
};
const midiToFreq = (midi)=>440*Math.pow(2,(midi-69)/12);

/* ===================== STATE ===================== */
let instrument = "guitar";
let tuneOffset = 0;
let capo = 0;
let voicingPref = "open";
let slashMode = false;
let slashBassPc = nameToPc("E");
let powerRootPref = "auto";
let bassFollowString = 6;

let baseTuning = structuredClone(GUITAR_6);
let activeStrings = [6,5,4,3,2,1];

const selectedByString = new Map();
function resetSelected(){
  selectedByString.clear();
  ALL_COLS.forEach(s=>selectedByString.set(s,null));
}
resetSelected();

/* ============ URL state (hash) ============ */
let saveTimer = null;
function scheduleSave(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveStateToHash, 120);
}
function saveStateToHash(){
  const params = new URLSearchParams();
  params.set("i", instrument);
  params.set("t", String(tuneOffset));
  params.set("c", String(capo));
  params.set("v", voicingPref);
  params.set("p", powerRootPref);
  params.set("s", slashMode ? "1":"0");
  params.set("b", pcToName(slashBassPc));
  params.set("bf", String(bassFollowString));

  const parts = [];
  for(const s of ALL_COLS){
    if(!activeStrings.includes(s)) continue;
    const f = selectedByString.get(s);
    parts.push(`${s}:${f===null?"x":f}`);
  }
  params.set("pos", parts.join("|"));
  const newHash = "#" + params.toString();
  if(location.hash !== newHash) history.replaceState(null, "", newHash);
}
function loadStateFromHash(){
  if(!location.hash || location.hash.length<2) return false;
  const params = new URLSearchParams(location.hash.slice(1));
  const i = params.get("i"); if(i) instrument = i;
  const t = params.get("t"); if(t!==null && t!=="") tuneOffset = Number(t);
  const c = params.get("c"); if(c!==null && c!=="") capo = Number(c);
  const v = params.get("v"); if(v) voicingPref = v;
  const p = params.get("p"); if(p) powerRootPref = p;
  const s = params.get("s"); if(s) slashMode = (s==="1");
  const b = params.get("b"); if(b && NOTE_NAMES.includes(b)) slashBassPc = nameToPc(b);
  const bf = params.get("bf"); if(bf!==null && bf!=="") bassFollowString = Number(bf);

  const pos = params.get("pos");
  if(pos){
    resetSelected();
    const pairs = pos.split("|").map(x=>x.trim()).filter(Boolean);
    for(const pr of pairs){
      const [ss, ff] = pr.split(":");
      const sNum = Number(ss);
      if(!Number.isFinite(sNum)) continue;
      if(ff==="x") selectedByString.set(sNum, null);
      else{
        const fNum = Number(ff);
        if(Number.isFinite(fNum)) selectedByString.set(sNum, fNum);
      }
    }
  }
  return true;
}

/* ===================== AUDIO (POKO) ===================== */
let audioCtx = null;
function getCtx(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  return audioCtx;
}
function poko(freq, duration=0.12){
  const ctx = getCtx();
  const now = ctx.currentTime;
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  const filt = ctx.createBiquadFilter();

  osc.type = "sine";
  osc.frequency.setValueAtTime(freq*1.6, now);
  osc.frequency.exponentialRampToValueAtTime(freq, now + 0.04);

  filt.type = "lowpass";
  filt.frequency.setValueAtTime(Math.min(5200, freq*8), now);
  filt.Q.setValueAtTime(0.8, now);

  gain.gain.setValueAtTime(0.0001, now);
  gain.gain.exponentialRampToValueAtTime(0.85, now + 0.005);
  gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

  osc.connect(filt); filt.connect(gain); gain.connect(ctx.destination);
  osc.start(now);
  osc.stop(now + duration + 0.02);
}

/* ===================== TUNING ===================== */
function currentTuning(){
  const t = {};
  const capoOffset = (instrument==="guitar") ? capo : 0;
  for(const s of activeStrings){
    t[s] = baseTuning[s] + tuneOffset + capoOffset;
  }
  return t;
}

function pulseCell(cell){
  cell.classList.remove('pulse'); void cell.offsetWidth; cell.classList.add('pulse');
}

/* ===================== BUILDERS ===================== */
function buildCapoSel(){
  const sel = document.getElementById('capoSel');
  sel.innerHTML = "";
  const opt0 = document.createElement('option');
  opt0.value = "0"; opt0.textContent = "ã‚«ãƒãªã—";
  sel.appendChild(opt0);
  for(let i=1;i<=12;i++){
    const o = document.createElement('option');
    o.value = String(i); o.textContent = `ã‚«ãƒ${i}`;
    sel.appendChild(o);
  }
}

const QUALITIES = [
  {id:"maj",  label:""},
  {id:"min",  label:"m"},
  {id:"5",    label:"5"},
  {id:"7",    label:"7"},
  {id:"maj7", label:"maj7"},
  {id:"m7",   label:"m7"},
  {id:"sus2", label:"sus2"},
  {id:"sus4", label:"sus4"},
  {id:"6",    label:"6"},
  {id:"add9", label:"add9"},
  {id:"dim",  label:"dim"},
];
function buildQualitySel(selectEl){
  selectEl.innerHTML = "";
  const o0 = document.createElement('option');
  o0.value="all"; o0.textContent="ã™ã¹ã¦";
  selectEl.appendChild(o0);
  QUALITIES.forEach(q=>{
    const o=document.createElement('option');
    o.value=q.id; o.textContent=q.id;
    selectEl.appendChild(o);
  });
}
function buildBassNoteSel(){
  const sel = document.getElementById('bassNoteSel');
  sel.innerHTML="";
  NOTE_NAMES.forEach(n=>{
    const o=document.createElement('option');
    o.value=n; o.textContent=n;
    sel.appendChild(o);
  });
}
function repopulateBassFollowSel(){
  const sel = document.getElementById('bassFollowSel');
  sel.innerHTML = "";
  const strings = [...activeStrings].sort((a,b)=>b-a);
  strings.forEach(s=>{
    const o=document.createElement('option');
    o.value=String(s);
    o.textContent=`${s}å¼¦ã§ãƒ«ãƒ¼ãƒˆ`;
    sel.appendChild(o);
  });
}

function buildStringsHeader(targetId){
  const row = document.getElementById(targetId);
  if(!row) return;
  row.innerHTML = "";

  const left = document.createElement('div');
  left.textContent = "";
  row.appendChild(left);

  const tuning = currentTuning();
  for(const s of ALL_COLS){
    const wrap = document.createElement('div');
    wrap.className = "slabwrap";
    wrap.id = `${targetId}-slw${s}`;

    const open = document.createElement('div');
    open.className = "openname";
    open.id = `${targetId}-open${s}`;
    open.textContent = activeStrings.includes(s) ? midiToName(tuning[s]) : "â€”";

    const slab = document.createElement('div');
    slab.className = "slab";
    slab.textContent = `${s}`;

    wrap.appendChild(open);
    wrap.appendChild(slab);
    row.appendChild(wrap);
  }
}

function buildBoard(targetBoardId){
  const board = document.getElementById(targetBoardId);
  if(!board) return;
  board.innerHTML = "";

  const fret0 = document.createElement('div');
  fret0.className = "fret openrow";
  fret0.textContent = "0";
  board.appendChild(fret0);

  for(const s of ALL_COLS){
    const c = document.createElement('div');
    c.className = "cell openrow";
    c.dataset.board = targetBoardId;
    c.dataset.string = String(s);
    c.dataset.fret = "0";
    board.appendChild(c);
  }

  const spL = document.createElement('div');
  spL.className = "spacer left";
  board.appendChild(spL);
  for(let i=0;i<6;i++){
    const sp = document.createElement('div');
    sp.className="spacer";
    board.appendChild(sp);
  }

  const dotFrets = new Set([3,5,7,9,15,17,19,21]);
  for(let f=1; f<=FRETS; f++){
    const fr = document.createElement('div');
    fr.className="fret";
    fr.textContent=String(f);
    board.appendChild(fr);

    for(const s of ALL_COLS){
      const cell = document.createElement('div');
      cell.className = "cell";
      cell.dataset.board = targetBoardId;
      cell.dataset.string = String(s);
      cell.dataset.fret = String(f);

      if(f===12) cell.classList.add('double');
      if(dotFrets.has(f)){
        const pm=document.createElement('span');
        pm.className="posmark";
        cell.appendChild(pm);
      }
      board.appendChild(cell);
    }
  }
}

/* âœ… Piano build: fit whole range into element height (avoid 0-height) */
function buildPianoFit(pianoEl){
  if(!pianoEl) return false;

  pianoEl.innerHTML = "";

  // ğŸ”¥ å¼·åˆ¶çš„ã«é«˜ã•ã‚’ç¢ºä¿ï¼ˆä¸»ã«ã‚¹ãƒãƒ›/åˆå›æç”»ç›´å¾Œï¼‰
  if(pianoEl.clientHeight < 100){
    pianoEl.style.minHeight = "60vh";
  }

  const h = pianoEl.clientHeight;
  const w = pianoEl.clientWidth;

  // ã¾ã é«˜ã•ãŒå–ã‚Œãªã„ãªã‚‰ falseï¼ˆdeferredã§å†è©¦è¡Œã•ã›ã‚‹ï¼‰
  if(h < 100 || w < 30) return false;

  const count = (MAX_MIDI - MIN_MIDI + 1);
  const stepH = Math.max(4, h / count);
  const whiteH = stepH;
  const blackH = stepH * 0.75;
  const blackW = Math.max(40, w * 0.75);

  for(let midi=MIN_MIDI; midi<=MAX_MIDI; midi++){
    const y = (midi - MIN_MIDI) * stepH;

    if(!isBlack(midi)){
      const wEl=document.createElement('div');
      wEl.className="key-white";
      wEl.id=`${pianoEl.id}-key${midi}`;
      wEl.style.bottom = `${y}px`;
      wEl.style.height = `${whiteH}px`;
      wEl.textContent = midiToName(midi);
      pianoEl.appendChild(wEl);
    }else{
      const b=document.createElement('div');
      b.className="key-black";
      b.id=`${pianoEl.id}-key${midi}`;
      b.style.bottom = `${y + (whiteH-blackH)/2}px`;
      b.style.height = `${blackH}px`;
      b.style.width = `${blackW}px`;
      b.textContent = midiToName(midi);
      pianoEl.appendChild(b);
    }
  }
  return true;
}

/* ===================== UPDATE UI ===================== */
function getSelectedMidis(){
  const tuning=currentTuning();
  const midis=[];
  for(const s of ALL_COLS){
    const f=selectedByString.get(s);
    if(f===null) continue;
    if(!activeStrings.includes(s)) continue;
    const m = tuning[s] + f;
    if(m<MIN_MIDI || m>MAX_MIDI) continue;
    midis.push(m);
  }
  return Array.from(new Set(midis)).sort((a,b)=>a-b);
}

function clearPianoActive(pianoEl){
  for(let midi=MIN_MIDI; midi<=MAX_MIDI; midi++){
    const el=document.getElementById(`${pianoEl.id}-key${midi}`);
    if(el) el.classList.remove('active');
  }
}
function updatePianoHighlights(){
  const midis=getSelectedMidis();
  const p1=document.getElementById('piano');
  const p2=document.getElementById('pianoM');
  [p1,p2].forEach(p=>{
    if(!p) return;
    clearPianoActive(p);
    for(const m of midis){
      const el=document.getElementById(`${p.id}-key${m}`);
      if(el) el.classList.add('active');
    }
  });
}

function updateHeaders(){
  const tuning=currentTuning();
  const updateRow=(rowId)=>{
    const row=document.getElementById(rowId);
    if(!row) return;
    for(const s of ALL_COLS){
      const wrap=document.getElementById(`${rowId}-slw${s}`);
      const open=document.getElementById(`${rowId}-open${s}`);
      if(!wrap || !open) continue;

      if(!activeStrings.includes(s)){
        wrap.classList.add('disabled');
        wrap.classList.remove('muted','mutedGlow');
        open.textContent="â€”";
      }else{
        wrap.classList.remove('disabled');
        open.textContent = midiToName(tuning[s]);
        if(selectedByString.get(s)===null){
          wrap.classList.add('muted','mutedGlow');
        }else{
          wrap.classList.remove('muted','mutedGlow');
        }
      }
    }
  };
  updateRow('stringsRow');
  updateRow('stringsRowM');
}

function syncBoardDisabledAndMuted(){
  document.querySelectorAll('.cell').forEach(cell=>{
    const s=Number(cell.dataset.string);
    if(!activeStrings.includes(s)){
      cell.classList.add('disabled');
      cell.classList.remove('mutedcol');
      return;
    }
    cell.classList.remove('disabled');
    if(selectedByString.get(s)===null) cell.classList.add('mutedcol');
    else cell.classList.remove('mutedcol');
  });
}

function markSelectedCells(){
  document.querySelectorAll('.cell.selected').forEach(el=>el.classList.remove('selected'));
  for(const s of ALL_COLS){
    const f = selectedByString.get(s);
    if(f===null) continue;
    document.querySelectorAll(`.cell[data-string="${s}"][data-fret="${f}"]`).forEach(cell=>{
      cell.classList.add('selected');
    });
  }
}

function updateUI(){
  updateHeaders();
  syncBoardDisabledAndMuted();
  markSelectedCells();
  updatePianoHighlights();
  scheduleSave();
}

/* ===================== CHORD ENGINE (common shapes only) ===================== */
const qualityLabel = (qid)=> (QUALITIES.find(x=>x.id===qid)?.label ?? "");

const OPEN_FORMS = {
  "C:maj":  {6:null,5:3,4:2,3:0,2:1,1:0},
  "D:maj":  {6:null,5:null,4:0,3:2,2:3,1:2},
  "E:maj":  {6:0,5:2,4:2,3:1,2:0,1:0},
  "G:maj":  {6:3,5:2,4:0,3:0,2:0,1:3},
  "A:maj":  {6:null,5:0,4:2,3:2,2:2,1:0},

  "A:min":  {6:null,5:0,4:2,3:2,2:1,1:0},
  "E:min":  {6:0,5:2,4:2,3:0,2:0,1:0},
  "D:min":  {6:null,5:null,4:0,3:2,2:3,1:1},

  "E:7":    {6:0,5:2,4:0,3:1,2:0,1:0},
  "A:7":    {6:null,5:0,4:2,3:0,2:2,1:0},
  "D:7":    {6:null,5:null,4:0,3:2,2:1,1:2},
  "G:7":    {6:3,5:2,4:0,3:0,2:0,1:1},

  "C:maj7": {6:null,5:3,4:2,3:0,2:0,1:0},
  "A:m7":   {6:null,5:0,4:2,3:0,2:1,1:0},
  "E:m7":   {6:0,5:2,4:0,3:0,2:0,1:0},

  "D:sus4": {6:null,5:null,4:0,3:2,2:3,1:3},
  "A:sus4": {6:null,5:0,4:2,3:2,2:3,1:0},
  "E:sus4": {6:0,5:2,4:2,3:2,2:0,1:0},

  "D:dim":  {6:null,5:null,4:0,3:1,2:0,1:1},
};

const BARRE = [
  {family:"E", q:"maj",  rootString:6, offs:{6:0,5:2,4:2,3:1,2:0,1:0}},
  {family:"E", q:"min",  rootString:6, offs:{6:0,5:2,4:2,3:0,2:0,1:0}},
  {family:"E", q:"7",    rootString:6, offs:{6:0,5:2,4:0,3:1,2:0,1:0}},
  {family:"E", q:"maj7", rootString:6, offs:{6:0,5:2,4:1,3:1,2:0,1:0}},
  {family:"E", q:"m7",   rootString:6, offs:{6:0,5:2,4:0,3:0,2:0,1:0}},
  {family:"E", q:"sus4", rootString:6, offs:{6:0,5:2,4:2,3:2,2:0,1:0}},
  {family:"E", q:"6",    rootString:6, offs:{6:0,5:2,4:2,3:1,2:2,1:0}},
  {family:"E", q:"add9", rootString:6, offs:{6:0,5:2,4:2,3:1,2:0,1:2}},
  {family:"E", q:"dim",  rootString:6, offs:{6:0,5:1,4:2,3:0,2:2,1:0}},
  {family:"E", q:"5",    rootString:6, offs:{6:0,5:2,4:2,3:null,2:null,1:null}},

  {family:"A", q:"maj",  rootString:5, offs:{6:null,5:0,4:2,3:2,2:2,1:0}},
  {family:"A", q:"min",  rootString:5, offs:{6:null,5:0,4:2,3:2,2:1,1:0}},
  {family:"A", q:"7",    rootString:5, offs:{6:null,5:0,4:2,3:0,2:2,1:0}},
  {family:"A", q:"maj7", rootString:5, offs:{6:null,5:0,4:2,3:1,2:2,1:0}},
  {family:"A", q:"m7",   rootString:5, offs:{6:null,5:0,4:2,3:0,2:1,1:0}},
  {family:"A", q:"sus4", rootString:5, offs:{6:null,5:0,4:2,3:2,2:3,1:0}},
  {family:"A", q:"6",    rootString:5, offs:{6:null,5:0,4:2,3:2,2:2,1:2}},
  {family:"A", q:"add9", rootString:5, offs:{6:null,5:0,4:2,3:2,2:0,1:0}},
  {family:"A", q:"dim",  rootString:5, offs:{6:null,5:0,4:1,3:2,2:1,1:2}},
  {family:"A", q:"5",    rootString:5, offs:{6:null,5:0,4:2,3:2,2:null,1:null}},
];

function soundingRootPc(rootPc){
  const semis = (instrument==="guitar") ? (capo + tuneOffset) : tuneOffset;
  return mod(rootPc + semis, 12);
}
function chordName(rootPc, qid){
  return pcToName(soundingRootPc(rootPc)) + qualityLabel(qid);
}
function voicingFromOpenForm(form){
  const v = {};
  for(const s of ALL_COLS){
    const f = form[s];
    if(f===null || f===undefined) v[s]=null;
    else if(f===0) v[s]=0;
    else{
      const abs = capo + f;
      if(abs>FRETS) return null;
      v[s]=abs;
    }
  }
  return v;
}
function voicingFromBarre(shape, barreFret){
  const v = {};
  for(const s of ALL_COLS){
    const o = shape.offs[s];
    if(o===null || o===undefined) v[s]=null;
    else{
      const f = barreFret + o;
      if(f<0 || f>FRETS) return null;
      v[s]=f;
    }
  }
  return v;
}
function isPlayableCommon(voicing){
  const frets=[];
  let count=0;
  for(const s of ALL_COLS){
    const f=voicing[s];
    if(f===null) continue;
    count++; frets.push(f);
  }
  if(count<2) return false;
  const minF=Math.min(...frets), maxF=Math.max(...frets);
  if(maxF-minF>5) return false;
  if(minF>17) return false;
  return true;
}
function shapesForQuality(qid){
  if(qid!=="5") return BARRE.filter(s=>s.q===qid);
  if(powerRootPref==="6") return BARRE.filter(s=>s.q==="5" && s.rootString===6);
  if(powerRootPref==="5") return BARRE.filter(s=>s.q==="5" && s.rootString===5);
  return BARRE.filter(s=>s.q==="5");
}
function voicingLowestMidi(voicing){
  const tuning=currentTuning();
  let best=null;
  for(const s of ALL_COLS){
    const f=voicing[s];
    if(f===null) continue;
    const midi=tuning[s]+f;
    if(best===null || midi<best) best=midi;
  }
  return best;
}
function voicingBassPc(voicing){
  const m=voicingLowestMidi(voicing);
  return (m===null)?null:mod(m,12);
}
function generateCommonVoicings(rootPc, qid){
  if(instrument!=="guitar") return [];
  const tuning=currentTuning();
  const out=[];

  const openKey = `${pcToName(rootPc)}:${qid}`;
  if(OPEN_FORMS[openKey]){
    const v=voicingFromOpenForm(OPEN_FORMS[openKey]);
    if(v && isPlayableCommon(v)) out.push({voicing:v, tag:"open"});
  }

  const shapes=shapesForQuality(qid);
  for(const sh of shapes){
    const rs=sh.rootString;
    const openMidi=tuning[rs];
    for(let bf=0; bf<=FRETS; bf++){
      if(mod(openMidi+bf,12)!==rootPc) continue;
      const v=voicingFromBarre(sh,bf);
      if(!v) continue;
      if(!isPlayableCommon(v)) continue;
      out.push({voicing:v, tag:`barre-${sh.family}`});
    }
  }

  const seen=new Set();
  const uniq=[];
  for(const r of out){
    const sig=ALL_COLS.map(s=>(r.voicing[s]===null?"x":r.voicing[s])).join("-");
    if(seen.has(sig)) continue;
    seen.add(sig);
    uniq.push(r);
  }

  uniq.sort((a,b)=>{
    const ma=Math.min(...ALL_COLS.map(s=>a.voicing[s]).filter(x=>x!==null));
    const mb=Math.min(...ALL_COLS.map(s=>b.voicing[s]).filter(x=>x!==null));
    return ma-mb;
  });

  return uniq;
}
function pickPreferredVoicing(voicings){
  if(!voicings.length) return null;
  if(voicingPref==="open"){
    const o=voicings.find(v=>v.tag==="open");
    return o || voicings[0];
  }
  if(voicingPref==="barreE"){
    const e=voicings.find(v=>v.tag==="barre-E");
    return e || voicings[0];
  }
  if(voicingPref==="barreA"){
    const a=voicings.find(v=>v.tag==="barre-A");
    return a || voicings[0];
  }
  return voicings[0];
}
function applyBassRootOnly(rootPc){
  ALL_COLS.forEach(s=>selectedByString.set(s,null));
  if(!activeStrings.includes(bassFollowString)) { updateUI(); return; }

  const tuning=currentTuning();
  const s=bassFollowString;
  const openPc=mod(tuning[s],12);

  let f=mod(rootPc-openPc,12);
  if(f+12<=FRETS && f<=2) f+=12;
  if(f>FRETS) f=0;

  selectedByString.set(s,f);
  updateUI();
}
function applyVoicing(voicing){
  ALL_COLS.forEach(s=>selectedByString.set(s,null));
  if(!voicing){ updateUI(); return; }
  for(const s of ALL_COLS){
    const f=voicing[s];
    if(f===null) continue;
    selectedByString.set(s,f);
  }
  updateUI();
}

/* chord inventory + render */
let allChordItems=[];
function rebuildChordInventory(){
  allChordItems=[];
  for(const q of QUALITIES){
    for(let r=0;r<12;r++){
      if(instrument==="guitar"){
        const voicings=generateCommonVoicings(r,q.id);
        if(!voicings.length) continue;
        allChordItems.push({rootPc:r,qid:q.id,voicings});
      }else{
        // show only if exists in common guitar shapes
        const saved = {instrument, baseTuning, activeStrings, capo, powerRootPref};
        instrument="guitar"; baseTuning=structuredClone(GUITAR_6); activeStrings=[6,5,4,3,2,1]; capo=0; powerRootPref="auto";
        const voicings=generateCommonVoicings(r,q.id);
        instrument=saved.instrument; baseTuning=saved.baseTuning; activeStrings=saved.activeStrings; capo=saved.capo; powerRootPref=saved.powerRootPref;

        if(!voicings.length) continue;
        allChordItems.push({rootPc:r,qid:q.id,voicings:[]});
      }
    }
  }
}
function passesSearch(item, q){
  if(!q) return true;
  const s=q.toLowerCase().replace(/\s+/g,"");
  const base=chordName(item.rootPc,item.qid).toLowerCase();
  const slash=(base+`/${pcToName(slashBassPc)}`).toLowerCase();
  return base.includes(s) || slash.includes(s);
}
function renderChordGrid(targetGrid, qText, qFilter){
  if(!targetGrid) return;
  targetGrid.innerHTML="";

  let items=allChordItems
    .filter(it=>qFilter==="all" ? true : it.qid===qFilter)
    .filter(it=>passesSearch(it,qText))
    .sort((a,b)=>chordName(a.rootPc,a.qid).localeCompare(chordName(b.rootPc,b.qid)));

  for(const it of items){
    const btn=document.createElement('button');
    btn.className="cbtn";
    btn.type="button";

    const baseName=chordName(it.rootPc,it.qid);

    if(slashMode && instrument==="guitar"){
      const wanted=slashBassPc;
      const okVoicing = it.voicings.find(v=>voicingBassPc(v.voicing)===wanted);
      const isOk=!!okVoicing;
      btn.innerHTML = `${baseName}/${pcToName(wanted)} <span class="badge ${isOk?'ok':'ng'}">bass ${isOk?'ok':'NG'}</span>`;
      btn.onclick = ()=>{
        const picked = okVoicing || pickPreferredVoicing(it.voicings);
        applyVoicing(picked ? picked.voicing : null);
      };
    }else{
      btn.textContent=baseName;
      btn.onclick=()=>{
        if(instrument==="guitar"){
          const v=pickPreferredVoicing(it.voicings);
          applyVoicing(v ? v.voicing : null);
        }else{
          applyBassRootOnly(it.rootPc);
        }
      };
    }

    btn.ondblclick=()=>document.getElementById('btnClear').click();
    targetGrid.appendChild(btn);
  }
}

/* ===================== EVENTS ===================== */
function setInstrument(val){
  instrument=val;

  if(instrument==="guitar"){
    baseTuning=structuredClone(GUITAR_6);
    activeStrings=[6,5,4,3,2,1];
  }else if(instrument==="bass4"){
    baseTuning=structuredClone(BASS_4);
    activeStrings=[4,3,2,1];
    capo=0;
  }else if(instrument==="bass5"){
    baseTuning=structuredClone(BASS_5);
    activeStrings=[5,4,3,2,1];
    capo=0;
  }else{
    baseTuning=structuredClone(BASS_6);
    activeStrings=[6,5,4,3,2,1];
    capo=0;
  }

  const capoSel=document.getElementById('capoSel');
  const voSel=document.getElementById('voicingSel');
  const bassNoteSel=document.getElementById('bassNoteSel');
  const bassFollowSel=document.getElementById('bassFollowSel');
  const powerSel=document.getElementById('powerRootSel');
  const slashSel=document.getElementById('slashSel');

  if(instrument!=="guitar"){
    capoSel.disabled=true;
    voSel.disabled=true;
    powerSel.disabled=true;

    slashMode=false;
    slashSel.value="off";
    bassNoteSel.style.display="none";

    bassFollowSel.style.display="inline-block";
    repopulateBassFollowSel();
    bassFollowSel.value = String(bassFollowString);
  }else{
    capoSel.disabled=false;
    voSel.disabled=false;
    powerSel.disabled=false;

    bassFollowSel.style.display="none";
    bassNoteSel.style.display = slashMode ? "inline-block" : "none";
  }

  buildStringsHeader('stringsRow');
  buildStringsHeader('stringsRowM');

  rebuildChordInventory();
  renderAllChordViews();

  updateUI();
  rebuildPianosDeferred();
}

document.addEventListener('click',(e)=>{
  const cell=e.target.closest('.cell');
  if(!cell) return;

  const s=Number(cell.dataset.string);
  const f=Number(cell.dataset.fret);
  if(!activeStrings.includes(s)) return;

  const cur=selectedByString.get(s);
  if(cur===f){
    selectedByString.set(s,null); // mute
  }else{
    selectedByString.set(s,f);
    pulseCell(cell);
    const tuning=currentTuning();
    poko(midiToFreq(tuning[s]+f), 0.12);
  }
  updateUI();
});

document.getElementById('btnClear').onclick=()=>{
  ALL_COLS.forEach(s=>selectedByString.set(s,null));
  updateUI();
};

document.getElementById('instSel').onchange=(e)=>{ setInstrument(e.target.value); scheduleSave(); };
document.getElementById('tuneSel').onchange=(e)=>{
  tuneOffset=Number(e.target.value);
  buildStringsHeader('stringsRow');
  buildStringsHeader('stringsRowM');
  rebuildChordInventory();
  renderAllChordViews();
  updateUI();
  rebuildPianosDeferred();
};
document.getElementById('capoSel').onchange=(e)=>{
  capo=Number(e.target.value);
  if(instrument!=="guitar"){ capo=0; e.target.value="0"; }
  buildStringsHeader('stringsRow');
  buildStringsHeader('stringsRowM');
  rebuildChordInventory();
  renderAllChordViews();
  updateUI();
  rebuildPianosDeferred();
};
document.getElementById('voicingSel').onchange=(e)=>{ voicingPref=e.target.value; renderAllChordViews(); scheduleSave(); };
document.getElementById('powerRootSel').onchange=(e)=>{
  powerRootPref=e.target.value;
  rebuildChordInventory();
  renderAllChordViews();
  updateUI();
};
document.getElementById('slashSel').onchange=(e)=>{
  slashMode = (e.target.value==="on" && instrument==="guitar");
  document.getElementById('bassNoteSel').style.display = slashMode ? "inline-block" : "none";
  renderAllChordViews();
  scheduleSave();
};
document.getElementById('bassNoteSel').onchange=(e)=>{
  slashBassPc=nameToPc(e.target.value);
  renderAllChordViews();
  scheduleSave();
};
document.getElementById('bassFollowSel').onchange=(e)=>{
  bassFollowString=Number(e.target.value);
  scheduleSave();
};

document.getElementById('btnShare').onclick = async ()=>{
  saveStateToHash();
  const url = location.href;
  try{
    await navigator.clipboard.writeText(url);
    const btn = document.getElementById('btnShare');
    const old = btn.textContent;
    btn.textContent = "ã‚³ãƒ”ãƒ¼æ¸ˆã¿";
    btn.style.boxShadow = "var(--glowStrong)";
    setTimeout(()=>{ btn.textContent=old; btn.style.boxShadow=""; }, 900);
  }catch{
    prompt("ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ã­", url);
  }
};

/* ===================== Search / Filter (PC + Mobile) ===================== */
const pcSearch = document.getElementById('searchBox');
const pcQual = document.getElementById('qualitySel');
const mobSearch = document.getElementById('searchBoxM');
const mobQual = document.getElementById('qualitySelM');

function renderAllChordViews(){
  const pcQ = pcSearch ? pcSearch.value.trim() : "";
  const pcF = pcQual ? pcQual.value : "all";
  const mobQ = mobSearch ? mobSearch.value.trim() : "";
  const mobF = mobQual ? mobQual.value : "all";

  renderChordGrid(document.getElementById('chordGrid'), pcQ, pcF);
  renderChordGrid(document.getElementById('chordGridM'), mobQ, mobF);
}
if(pcSearch) pcSearch.oninput = ()=>renderAllChordViews();
if(pcQual) pcQual.onchange = ()=>renderAllChordViews();
if(mobSearch) mobSearch.oninput = ()=>renderAllChordViews();
if(mobQual) mobQual.onchange = ()=>renderAllChordViews();

/* ===================== Piano rebuild (fix disappearing) ===================== */
function isVisible(el){
  // display:none ã®è¦ç´ ã¯ offsetParent ãŒ null ã«ãªã‚Šã‚„ã™ã„
  return !!(el && el.offsetParent !== null);
}

function rebuildPianosDeferred(){
  // âœ… æç”»å¾Œã«å†ç”Ÿæˆï¼ˆdisplay:none / clientHeight=0 å¯¾ç­–ï¼‰
  requestAnimationFrame(()=>{
    let tries=0;

    const loop=()=>{
      tries++;

      const p1=document.getElementById('piano');
      const p2=document.getElementById('pianoM');

      let ok = true;

      // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ–¹ã ã‘ä½œã‚‹ï¼ˆéš ã‚Œã¦ã„ã‚‹æ–¹ã¯è§¦ã‚‰ãªã„ï¼‰
      if(p1 && isVisible(p1)) ok = buildPianoFit(p1) && ok;
      if(p2 && isVisible(p2)) ok = buildPianoFit(p2) && ok;

      updatePianoHighlights();

      // ã¾ã é«˜ã•ãŒå–ã‚Œãªã„å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤
      if(!ok && tries < 20){
        setTimeout(loop, 80);
      }
    };

    loop();
  });
}

/* ===================== INIT ===================== */
function applyStateToControls(){
  document.getElementById('instSel').value = instrument;
  document.getElementById('tuneSel').value = String(tuneOffset);
  document.getElementById('capoSel').value = String(capo);
  document.getElementById('voicingSel').value = voicingPref;
  document.getElementById('powerRootSel').value = powerRootPref;
  document.getElementById('slashSel').value = slashMode ? "on":"off";
  document.getElementById('bassNoteSel').value = pcToName(slashBassPc);
}

function init(){
  buildCapoSel();
  buildQualitySel(document.getElementById('qualitySel'));
  buildQualitySel(document.getElementById('qualitySelM'));
  buildBassNoteSel();

  buildBoard('board');
  buildBoard('boardM');

  loadStateFromHash();
  applyStateToControls();

  setInstrument(instrument);

  updateUI();
  saveStateToHash();

  rebuildPianosDeferred();
}
window.addEventListener('resize', rebuildPianosDeferred);
init();
</script>
</body>
</html>
