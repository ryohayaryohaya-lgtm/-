from flask import Flask, render_template_string

app = Flask(__name__)

NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]
BLACK_PCS = {1, 3, 6, 8, 10}

FRETS = 22

# Piano range (supports bass low B0)
MIN_MIDI = 23  # B0
MAX_MIDI = 84  # C6

# Tunings (MIDI open strings)
GUITAR_6 = {6: 40, 5: 45, 4: 50, 3: 55, 2: 59, 1: 64}  # EADGBE
BASS_4   = {4: 28, 3: 33, 2: 38, 1: 43}                # E1 A1 D2 G2
BASS_5   = {5: 23, 4: 28, 3: 33, 2: 38, 1: 43}         # B0 E1 A1 D2 G2
BASS_6   = {6: 23, 5: 28, 4: 33, 3: 38, 2: 43, 1: 48}  # B0 E1 A1 D2 G2 C3

HTML = r"""
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ギター／ベースピアノ変換サイト</title>
<style>
:root{
  --bg0:#050505;
  --bg1:#0a0a0a;

  --panel: rgba(10,10,10,.58);
  --shadow: 0 12px 34px rgba(0,0,0,.58);
  --glow: 0 0 10px rgba(255,255,255,.45), 0 0 22px rgba(255,255,255,.25);
  --glowStrong: 0 0 12px rgba(255,255,255,.70), 0 0 30px rgba(255,255,255,.40);

  /* Bigger fretboard */
  --cellW: 40px;
  --cellH: 34px;
  --fretW: 46px;
  --spacerH: 34px; /* 0-1 gap */

  /* piano */
  --pW: 190px;
  --stepH: 14px;
  --whiteH: 14px;
  --blackH: 11px;
  --blackW: 132px;

  --radius: 18px;
}

*{ box-sizing:border-box; }
html, body{ height:100%; }
body{
  margin:0;
  color:#f4f4f4;
  font-family: system-ui, "Segoe UI", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
  background:
    radial-gradient(1100px 520px at 65% 18%, rgba(255,255,255,.10), transparent 62%),
    radial-gradient(900px 680px at 25% 72%, rgba(255,255,255,.06), transparent 60%),
    linear-gradient(90deg, var(--bg0), var(--bg1) 55%, rgba(255,255,255,.06) 100%);
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background:
    repeating-linear-gradient(0deg, rgba(255,255,255,.03) 0 1px, transparent 1px 4px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.02) 0 1px, transparent 1px 4px);
  mix-blend-mode: overlay;
  opacity:.25;
}

.wrap{ max-width: 1440px; margin: 0 auto; padding: 14px; }

.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
h1{
  margin:0;
  font-size:22px;
  font-weight:1000;
  letter-spacing:.5px;
  text-shadow: var(--glow);
}
.controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
select, .btn, input, label{
  border:1px solid rgba(255,255,255,.30);
  background: rgba(10,10,10,.55);
  color:#fff;
  padding:10px 12px;
  border-radius:14px;
  font-weight:1000;
  font-size:14px;
  cursor:pointer;
  transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
  outline:none;
}
input{ cursor:text; }
select:hover, .btn:hover, input:hover, label:hover{
  border-color: rgba(255,255,255,.58);
  box-shadow: var(--glow);
}
.btn:active{ transform: translateY(1px); }

.toggle{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.30);
  background: rgba(10,10,10,.55);
  user-select:none;
}
.toggle input{ width:18px; height:18px; cursor:pointer; }

.main{ display:flex; gap:14px; align-items:flex-start; }

.panel{
  border-radius:var(--radius);
  background: var(--panel);
  border:1px solid rgba(255,255,255,.20);
  box-shadow: var(--shadow);
  overflow:hidden;
  backdrop-filter: blur(8px);
}
.panel-title{
  padding:10px 12px;
  font-weight:1000;
  letter-spacing:.3px;
  font-size:15px;
  border-bottom: 1px solid rgba(255,255,255,.14);
  background: linear-gradient(90deg, rgba(255,255,255,.10), rgba(0,0,0,0));
}
.panel-body{ padding:12px; }

.fret-piano{ display:flex; gap:12px; align-items:flex-start; }

/* mute strip */
.mute-strip{ display:flex; align-items:center; gap:8px; margin: 0 0 10px 0; }
.mute-x{
  width:18px; text-align:center; font-weight:1000; text-shadow: var(--glow);
  border-radius:10px;
  padding:4px 6px;
}
.mute-x.glow{
  box-shadow: 0 0 16px rgba(255,255,255,.50);
  border:1px solid rgba(255,255,255,.35);
  background: rgba(255,255,255,.08);
}
.dot{
  width:14px; height:14px; border-radius:50%;
  background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.18);
  box-shadow: inset 0 0 10px rgba(0,0,0,.65);
}
.dot.on{ background: rgba(255,255,255,.95); border-color: rgba(255,255,255,.90); box-shadow: var(--glowStrong); }
.dot.mutedGlow{
  background: rgba(255,255,255,.16);
  border-color: rgba(255,255,255,.35);
  box-shadow: 0 0 16px rgba(255,255,255,.40);
}

/* header labels */
.strings-row{
  display:grid;
  grid-template-columns: var(--fretW) repeat(6, var(--cellW));
  gap:8px 0;
  align-items:stretch;
  margin-bottom:8px;
}
.slabwrap{
  border:1px solid rgba(255,255,255,.14);
  border-radius:12px;
  background: rgba(0,0,0,.35);
  padding:6px 0 7px 0;
  text-align:center;
}
.openname{ font-weight:1000; font-size:12px; color: rgba(255,255,255,.92); line-height:1; text-shadow: 0 0 10px rgba(255,255,255,.15); }
.slab{ margin-top:4px; font-weight:1000; font-size:13px; color: rgba(255,255,255,.92); line-height:1; }
.slabwrap.disabled{ opacity:.25; }
.slabwrap.muted{ opacity:.40; background: rgba(255,255,255,.06); }
.slabwrap.mutedGlow{ opacity:.55; box-shadow: 0 0 18px rgba(255,255,255,.40); border-color: rgba(255,255,255,.40); }

/* scroll */
.scroll{ max-height: 78vh; overflow:auto; padding-right:6px; }
.scroll::-webkit-scrollbar{ width:10px; }
.scroll::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.22);
  border-radius:999px;
  border:2px solid rgba(0,0,0,.55);
}
.scroll::-webkit-scrollbar-track{ background: rgba(0,0,0,.35); border-radius:999px; }

/* board */
.board{
  display:grid;
  grid-template-columns: var(--fretW) repeat(6, var(--cellW));
  grid-auto-rows: var(--cellH);
  gap:0;
  border-radius:14px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.22);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -1px 0 rgba(0,0,0,.80),
    0 0 18px rgba(255,255,255,.08);
  background: rgba(0,0,0,.25);
}
.fret{
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:1000;
  font-size:13px;
  color: rgba(255,255,255,.92);
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.45));
  border-right:1px solid rgba(255,255,255,.18);
  border-bottom:1px solid rgba(255,255,255,.10);
  text-shadow: 0 0 10px rgba(255,255,255,.22);
}
.fret.openrow{
  background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(0,0,0,.38));
}
.cell{
  cursor:pointer;
  user-select:none;
  position:relative;
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.42));
  border-right:1px solid rgba(255,255,255,.18);
  border-bottom:1px solid rgba(255,255,255,.10);
  transition: background .12s ease, box-shadow .12s ease;
}
.cell::before{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.18),
    inset 0 -1px 0 rgba(0,0,0,.75);
  opacity:.9;
}
.cell:hover{ background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.38)); }
.cell.selected{
  background: linear-gradient(180deg, rgba(255,255,255,.38), rgba(0,0,0,.25));
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.35), var(--glowStrong);
}
.cell.disabled{ opacity:.18; pointer-events:none; filter: grayscale(1); }

.cell.openrow{ background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(0,0,0,.36)); }
.cell.openrow:hover{ background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(0,0,0,.34)); }

.cell.mutedcol{ opacity:.28; background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.50)); }

/* spacer row between fret0 and fret1 */
.spacer{
  height: var(--spacerH);
  background: rgba(255,255,255,.04);
  border-bottom:1px solid rgba(255,255,255,.10);
}
.spacer.left{ border-right:1px solid rgba(255,255,255,.18); }

/* pulse */
@keyframes pulseGlow{
  0%   { box-shadow: inset 0 0 0 2px rgba(255,255,255,.20), 0 0 0 rgba(255,255,255,0); }
  40%  { box-shadow: inset 0 0 0 2px rgba(255,255,255,.62), 0 0 30px rgba(255,255,255,.45); }
  100% { box-shadow: inset 0 0 0 2px rgba(255,255,255,.35), 0 0 18px rgba(255,255,255,.22); }
}
.cell.pulse{ animation: pulseGlow .45s ease-out; }

/* pos marks */
.cell .posmark{
  position:absolute;
  width:9px; height:9px;
  border-radius:50%;
  background: rgba(255,255,255,.95);
  right:7px;
  top:7px;
  box-shadow: var(--glow);
}
.cell.double::after{
  content:"";
  position:absolute;
  width:9px; height:9px;
  border-radius:50%;
  background: rgba(255,255,255,.95);
  right:20px;
  top:7px;
  box-shadow: var(--glow);
}

/* piano */
.piano{
  width:var(--pW);
  height: calc(({{MAX_MIDI}} - {{MIN_MIDI}} + 1) * var(--stepH));
  position:relative;
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.22);
  border-radius:16px;
  overflow:hidden;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.12), 0 0 24px rgba(255,255,255,.06);
}
.key-white{
  position:absolute;
  left:0;
  width:var(--pW);
  height:var(--whiteH);
  border-top:1px solid rgba(255,255,255,.16);
  display:flex;
  align-items:center;
  justify-content:flex-end;
  padding-right:8px;
  font-weight:1000;
  font-size:12px;
  color: rgba(255,255,255,.90);
  background: rgba(255,255,255,.06);
}
.key-black{
  position:absolute;
  left:0;
  width:132px;
  height:var(--blackH);
  background: rgba(0,0,0,.95);
  border:1px solid rgba(255,255,255,.34);
  border-radius:6px;
  z-index:3;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  padding-right:6px;
  font-weight:1000;
  font-size:11px;
  color: rgba(255,255,255,.96);
  box-shadow: 0 2px 14px rgba(0,0,0,.75);
}
.key-white.active{
  background: rgba(255,255,255,.20);
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.25), var(--glow);
}
.key-black.active{
  background: rgba(255,255,255,.75);
  color:#111;
  border-color: rgba(255,255,255,.70);
  box-shadow: var(--glowStrong);
}

/* right */
.right-col{ display:flex; flex-direction:column; gap:14px; min-width: 420px; max-width: 640px; }
.chordlist{ max-height: 74vh; overflow:auto; padding-right:6px; }
.chordlist::-webkit-scrollbar{ width:10px; }
.chordlist::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.22);
  border-radius:999px;
  border:2px solid rgba(0,0,0,.55);
}
.chordgrid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
.cbtn{
  border:1px solid rgba(255,255,255,.20);
  background: rgba(0,0,0,.35);
  color:#fff;
  padding:10px 8px;
  border-radius:14px;
  font-weight:1000;
  font-size:14px;
  cursor:pointer;
  transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
}
.cbtn:hover{ border-color: rgba(255,255,255,.55); box-shadow: var(--glow); }
.cbtn:active{ transform: translateY(1px); }
.cbtn[disabled]{ opacity:.35; cursor:not-allowed; }

.badge{
  display:inline-block;
  margin-left:6px;
  font-size:12px;
  font-weight:1000;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.28);
  background: rgba(255,255,255,.08);
}
.badge.ok{ box-shadow: 0 0 14px rgba(255,255,255,.35); }
.badge.ng{ opacity:.7; }

@media (max-width: 1120px){
  .main{ flex-direction:column; }
  .right-col{ max-width: unset; }
  .chordgrid{ grid-template-columns: repeat(4, 1fr); }
}
@media (max-width: 640px){
  .chordgrid{ grid-template-columns: repeat(3, 1fr); }
}
</style>
</head>
<body>
<div class="wrap">

  <div class="header">
    <h1>ギター／ベースピアノ変換サイト</h1>
    <div class="controls">
      <select id="instSel" title="楽器">
        <option value="guitar">ギター（6弦）</option>
        <option value="bass4">ベース（4弦）</option>
        <option value="bass5">ベース（5弦）</option>
        <option value="bass6">ベース（6弦）</option>
      </select>

      <select id="tuneSel" title="チューニング">
        <option value="0">標準</option>
        <option value="-1">半音下げ</option>
        <option value="-2">全音下げ</option>
      </select>

      <select id="capoSel" title="仮想カポ（ギターのみ）">
        <option value="0">カポなし</option>
        {% for i in range(1, 13) %}
          <option value="{{i}}">カポ{{i}}</option>
        {% endfor %}
      </select>

      <select id="voicingSel" title="押さえ方（一般的）">
        <option value="open">OPEN優先</option>
        <option value="barreE">Eフォーム優先</option>
        <option value="barreA">Aフォーム優先</option>
      </select>

      <select id="powerRootSel" title="パワーコード(5) ルート弦（ギター）">
        <option value="auto">Power: 自動</option>
        <option value="6">Power: 6弦ルート</option>
        <option value="5">Power: 5弦ルート</option>
      </select>

      <label class="toggle" title="オンコードモード（例: C/E）">
        <input id="slashMode" type="checkbox">
        <span>オンコード</span>
      </label>

      <select id="bassNoteSel" title="オンコードのベース音" style="display:none;"></select>

      <select id="bassFollowSel" title="ベース：ルート追従する弦" style="display:none;"></select>

      <button class="btn" id="btnClear" type="button">クリア</button>
    </div>
  </div>

  <div class="main">
    <!-- left -->
    <div class="panel">
      <div class="panel-title">指板（0〜22 / 縦スクロール） + ピアノロール（無音表示）</div>
      <div class="panel-body fret-piano">

        <div>
          <div class="mute-strip" id="muteStrip">
            <div class="mute-x" id="muteX">X</div>
          </div>

          <div class="strings-row">
            <div></div>
            {% for s in [6,5,4,3,2,1] %}
              <div class="slabwrap" id="slw{{s}}">
                <div class="openname" id="open{{s}}">—</div>
                <div class="slab">{{s}}</div>
              </div>
            {% endfor %}
          </div>

          <div class="scroll">
            <div class="board" id="board">
              <!-- fret 0 -->
              <div class="fret openrow">0</div>
              {% for s in [6,5,4,3,2,1] %}
                <div class="cell openrow" data-string="{{s}}" data-fret="0"></div>
              {% endfor %}

              <!-- spacer -->
              <div class="spacer left"></div>
              {% for _ in range(6) %}
                <div class="spacer"></div>
              {% endfor %}

              <!-- frets 1..22 -->
              {% for f in range(1, FRETS+1) %}
                <div class="fret">{{f}}</div>
                {% for s in [6,5,4,3,2,1] %}
                  {% set has_dot = f in [3,5,7,9,15,17,19,21] %}
                  {% set is_double = f in [12] %}
                  <div class="cell {% if is_double %}double{% endif %}" data-string="{{s}}" data-fret="{{f}}">
                    {% if has_dot %}<span class="posmark"></span>{% endif %}
                  </div>
                {% endfor %}
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="piano" id="piano"></div>

      </div>
    </div>

    <!-- right -->
    <div class="right-col">
      <div class="panel">
        <div class="panel-title">コード一覧（一般的な押さえ方のみ / 押さえられないものは非表示）</div>
        <div class="panel-body">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <input id="searchBox" placeholder="検索 (例: C5, C#dim, Bb7, C/E)" style="flex:1; min-width:240px;">
            <select id="qualitySel" title="絞り込み">
              <option value="all">すべて</option>
            </select>
          </div>
          <div style="margin-top:10px; color:rgba(255,255,255,.88); font-weight:900; font-size:13px;">
            クリックで自動入力 / ダブルクリックで解除（ベースは<b>ルートのみ</b>）
          </div>
          <div class="chordlist" style="margin-top:10px;">
            <div class="chordgrid" id="chordGrid"></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ---------------- basics ---------------- */
const NOTE_NAMES = {{ NOTE_NAMES|tojson }};
const BLACK_PCS = new Set({{ black_pcs|tojson }});
const MIN_MIDI = {{ MIN_MIDI }};
const MAX_MIDI = {{ MAX_MIDI }};
const FRETS = {{ FRETS }};

const GUITAR_6 = {{ guitar6|tojson }};
const BASS_4   = {{ bass4|tojson }};
const BASS_5   = {{ bass5|tojson }};
const BASS_6   = {{ bass6|tojson }};

const ALL_COLS = [6,5,4,3,2,1];

function mod(n,m){ return ((n%m)+m)%m; }
function isBlack(midi){ return BLACK_PCS.has(midi % 12); }
function midiToName(midi){
  const note = NOTE_NAMES[midi % 12];
  const oct = Math.floor(midi / 12) - 1;
  return `${note}${oct}`;
}
function pcToName(pc){ return NOTE_NAMES[mod(pc,12)]; }
function nameToPc(n){ return NOTE_NAMES.indexOf(n); }

/* ---------------- state ---------------- */
let instrument = "guitar"; // guitar | bass4 | bass5 | bass6
let tuneOffset = 0;        // 0, -1, -2
let capo = 0;              // 0..12 (guitar only)
let voicingPref = "open";  // open | barreE | barreA
let slashMode = false;
let slashBassPc = 4;       // default E
let powerRootPref = "auto"; // auto | "6" | "5"

let bassFollowString = 6;  // user chosen (in bass modes)

let baseTuning = structuredClone(GUITAR_6);
let activeStrings = [6,5,4,3,2,1];

/* per string one position; null=muted */
const selectedByString = new Map();
function resetSelected(){
  selectedByString.clear();
  ALL_COLS.forEach(s => selectedByString.set(s, null));
}
resetSelected();

/* ---------------- audio: poko click ---------------- */
let audioCtx = null;
function getCtx(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function midiToFreq(midi){ return 440*Math.pow(2,(midi-69)/12); }
function poko(freq, duration=0.12){
  const ctx = getCtx();
  const now = ctx.currentTime;

  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  const filt = ctx.createBiquadFilter();

  osc.type = "sine";
  osc.frequency.setValueAtTime(freq*1.6, now);
  osc.frequency.exponentialRampToValueAtTime(freq, now + 0.04);

  filt.type = "lowpass";
  filt.frequency.setValueAtTime(Math.min(5200, freq*8), now);
  filt.Q.setValueAtTime(0.8, now);

  gain.gain.setValueAtTime(0.0001, now);
  gain.gain.exponentialRampToValueAtTime(0.9, now + 0.005);
  gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

  osc.connect(filt);
  filt.connect(gain);
  gain.connect(ctx.destination);

  osc.start(now);
  osc.stop(now + duration + 0.02);
}

/* ---------------- tuning ---------------- */
function currentTuning(){
  const t = {};
  const capoOffset = (instrument === "guitar") ? capo : 0;
  for(const s of activeStrings){
    t[s] = baseTuning[s] + tuneOffset + capoOffset;
  }
  return t;
}

/* ---------------- piano UI (no sound) ---------------- */
function buildPiano(){
  const piano = document.getElementById('piano');
  piano.innerHTML = "";

  const stepH  = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--stepH'));
  const whiteH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--whiteH'));
  const blackH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--blackH'));

  for(let midi = MIN_MIDI; midi <= MAX_MIDI; midi++){
    const y = (midi - MIN_MIDI) * stepH;

    if(!isBlack(midi)){
      const w = document.createElement('div');
      w.className = 'key-white';
      w.id = `key${midi}`;
      w.style.bottom = `${y}px`;
      w.style.height = `${whiteH}px`;
      w.textContent = midiToName(midi);
      piano.appendChild(w);
    }else{
      const b = document.createElement('div');
      b.className = 'key-black';
      b.id = `key${midi}`;
      b.style.bottom = `${y + (whiteH-blackH)/2}px`;
      b.textContent = midiToName(midi);
      piano.appendChild(b);
    }
  }
}
function clearPianoActive(){
  for(let midi = MIN_MIDI; midi <= MAX_MIDI; midi++){
    const el = document.getElementById(`key${midi}`);
    if(el) el.classList.remove('active');
  }
}
function getSelectedMidis(){
  const tuning = currentTuning();
  const midis = [];
  for(const s of ALL_COLS){
    const f = selectedByString.get(s);
    if(f === null) continue;
    if(!activeStrings.includes(s)) continue;
    const midi = tuning[s] + f;
    if(midi < MIN_MIDI || midi > MAX_MIDI) continue;
    midis.push(midi);
  }
  return Array.from(new Set(midis)).sort((a,b)=>a-b);
}

/* ---------------- UI helpers ---------------- */
function pulseCell(cell){
  cell.classList.remove('pulse');
  void cell.offsetWidth;
  cell.classList.add('pulse');
}

function updateMuteDots(){
  const strip = document.getElementById('muteStrip');
  const muteX = document.getElementById('muteX');
  strip.querySelectorAll('.dot').forEach(d => d.remove());

  let anyMuted = false;

  ALL_COLS.forEach(s=>{
    const d = document.createElement('div');
    const active = activeStrings.includes(s);
    const muted = active && selectedByString.get(s) === null;
    const on = active && !muted;
    if(muted) anyMuted = true;
    d.className = 'dot' + (on ? ' on' : '') + (muted ? ' mutedGlow' : '');
    strip.appendChild(d);
  });

  if(anyMuted) muteX.classList.add('glow');
  else muteX.classList.remove('glow');
}

function updateOpenNamesAndHeader(){
  const tuning = currentTuning();
  for(const s of ALL_COLS){
    const wrap = document.getElementById('slw'+s);
    const openEl = document.getElementById('open'+s);
    if(!wrap || !openEl) continue;

    if(!activeStrings.includes(s)){
      wrap.classList.add('disabled');
      wrap.classList.remove('muted','mutedGlow');
      openEl.textContent = "—";
      continue;
    }

    wrap.classList.remove('disabled');
    openEl.textContent = midiToName(tuning[s]);

    if(selectedByString.get(s) === null){
      wrap.classList.add('muted','mutedGlow');
    }else{
      wrap.classList.remove('muted','mutedGlow');
    }
  }
}

function syncBoardMutedCols(){
  document.querySelectorAll('.cell').forEach(cell=>{
    const s = Number(cell.dataset.string);
    if(!activeStrings.includes(s)){
      cell.classList.add('disabled');
      cell.classList.remove('mutedcol');
      return;
    }
    cell.classList.remove('disabled');
    if(selectedByString.get(s) === null) cell.classList.add('mutedcol');
    else cell.classList.remove('mutedcol');
  });
}

function updateUI(){
  updateMuteDots();
  updateOpenNamesAndHeader();
  syncBoardMutedCols();

  clearPianoActive();
  const midis = getSelectedMidis();
  midis.forEach(m=>{
    const el = document.getElementById(`key${m}`);
    if(el) el.classList.add('active');
  });
}

/* ---------------- fret click ---------------- */
document.addEventListener('click', (e)=>{
  const cell = e.target.closest('.cell');
  if(!cell) return;

  const s = Number(cell.dataset.string);
  const f = Number(cell.dataset.fret);
  if(!activeStrings.includes(s)) return;

  const cur = selectedByString.get(s);

  // clear other selection in same string
  document.querySelectorAll(`.cell.selected[data-string="${s}"]`)
    .forEach(el=>el.classList.remove('selected'));

  if(cur === f){
    selectedByString.set(s, null);
  }else{
    selectedByString.set(s, f);
    cell.classList.add('selected');
    pulseCell(cell);

    const tuning = currentTuning();
    poko(midiToFreq(tuning[s] + f), 0.12);
  }
  updateUI();
});

document.getElementById('btnClear').addEventListener('click', ()=>{
  ALL_COLS.forEach(s=>selectedByString.set(s,null));
  document.querySelectorAll('.cell.selected').forEach(el=>el.classList.remove('selected'));
  updateUI();
});

/* ---------------- chord engine (common chart-only) ---------------- */
const QUALITIES = [
  {id:"maj",  label:""},
  {id:"min",  label:"m"},
  {id:"5",    label:"5"},      // power chord
  {id:"7",    label:"7"},
  {id:"maj7", label:"maj7"},
  {id:"m7",   label:"m7"},
  {id:"sus2", label:"sus2"},
  {id:"sus4", label:"sus4"},
  {id:"6",    label:"6"},
  {id:"add9", label:"add9"},
  {id:"dim",  label:"dim"},    // diminished
];

const OPEN_FORMS = {
  "C:maj":  {6:null,5:3,4:2,3:0,2:1,1:0},
  "D:maj":  {6:null,5:null,4:0,3:2,2:3,1:2},
  "E:maj":  {6:0,5:2,4:2,3:1,2:0,1:0},
  "G:maj":  {6:3,5:2,4:0,3:0,2:0,1:3},
  "A:maj":  {6:null,5:0,4:2,3:2,2:2,1:0},

  "A:min":  {6:null,5:0,4:2,3:2,2:1,1:0},
  "E:min":  {6:0,5:2,4:2,3:0,2:0,1:0},
  "D:min":  {6:null,5:null,4:0,3:2,2:3,1:1},

  "E:7":    {6:0,5:2,4:0,3:1,2:0,1:0},
  "A:7":    {6:null,5:0,4:2,3:0,2:2,1:0},
  "D:7":    {6:null,5:null,4:0,3:2,2:1,1:2},
  "G:7":    {6:3,5:2,4:0,3:0,2:0,1:1},

  "C:maj7": {6:null,5:3,4:2,3:0,2:0,1:0},
  "A:m7":   {6:null,5:0,4:2,3:0,2:1,1:0},
  "E:m7":   {6:0,5:2,4:0,3:0,2:0,1:0},

  "D:sus4": {6:null,5:null,4:0,3:2,2:3,1:3},
  "A:sus4": {6:null,5:0,4:2,3:2,2:3,1:0},
  "E:sus4": {6:0,5:2,4:2,3:2,2:0,1:0},

  // one common dim-ish small shape
  "D:dim":  {6:null,5:null,4:0,3:1,2:0,1:1},
};

// Barre templates (common charts)
// NOTE: power chord templates are split by rootString=6 vs 5
const BARRE = [
  // E-family (root on 6th string)
  {family:"E", q:"maj",  rootString:6, offs:{6:0,5:2,4:2,3:1,2:0,1:0}},
  {family:"E", q:"min",  rootString:6, offs:{6:0,5:2,4:2,3:0,2:0,1:0}},
  {family:"E", q:"7",    rootString:6, offs:{6:0,5:2,4:0,3:1,2:0,1:0}},
  {family:"E", q:"maj7", rootString:6, offs:{6:0,5:2,4:1,3:1,2:0,1:0}},
  {family:"E", q:"m7",   rootString:6, offs:{6:0,5:2,4:0,3:0,2:0,1:0}},
  {family:"E", q:"sus4", rootString:6, offs:{6:0,5:2,4:2,3:2,2:0,1:0}},
  {family:"E", q:"sus2", rootString:6, offs:{6:0,5:2,4:2,3:4,2:0,1:0}},
  {family:"E", q:"6",    rootString:6, offs:{6:0,5:2,4:2,3:1,2:2,1:0}},
  {family:"E", q:"add9", rootString:6, offs:{6:0,5:2,4:2,3:1,2:0,1:2}},
  {family:"E", q:"dim",  rootString:6, offs:{6:0,5:1,4:2,3:0,2:2,1:0}},
  {family:"E", q:"5",    rootString:6, offs:{6:0,5:2,4:2,3:null,2:null,1:null}}, // power 6th root

  // A-family (root on 5th string)
  {family:"A", q:"maj",  rootString:5, offs:{6:null,5:0,4:2,3:2,2:2,1:0}},
  {family:"A", q:"min",  rootString:5, offs:{6:null,5:0,4:2,3:2,2:1,1:0}},
  {family:"A", q:"7",    rootString:5, offs:{6:null,5:0,4:2,3:0,2:2,1:0}},
  {family:"A", q:"maj7", rootString:5, offs:{6:null,5:0,4:2,3:1,2:2,1:0}},
  {family:"A", q:"m7",   rootString:5, offs:{6:null,5:0,4:2,3:0,2:1,1:0}},
  {family:"A", q:"sus4", rootString:5, offs:{6:null,5:0,4:2,3:2,2:3,1:0}},
  {family:"A", q:"sus2", rootString:5, offs:{6:null,5:0,4:2,3:2,2:0,1:0}},
  {family:"A", q:"6",    rootString:5, offs:{6:null,5:0,4:2,3:2,2:2,1:2}},
  {family:"A", q:"add9", rootString:5, offs:{6:null,5:0,4:2,3:2,2:0,1:0}},
  {family:"A", q:"dim",  rootString:5, offs:{6:null,5:0,4:1,3:2,2:1,1:2}},
  {family:"A", q:"5",    rootString:5, offs:{6:null,5:0,4:2,3:2,2:null,1:null}}, // power 5th root
];

function qualityLabel(qid){
  const q = QUALITIES.find(x=>x.id===qid);
  return q ? q.label : "";
}

function soundingRootPc(rootPc){
  const semis = (instrument==="guitar") ? (capo + tuneOffset) : tuneOffset;
  return mod(rootPc + semis, 12);
}
function chordName(rootPc, qid){
  return pcToName(soundingRootPc(rootPc)) + qualityLabel(qid);
}

function voicingFromOpenForm(form){
  const v = {};
  for(const s of ALL_COLS){
    const f = form[s];
    if(f === null || f === undefined) v[s] = null;
    else if(f === 0) v[s] = 0;
    else{
      const abs = capo + f;
      if(abs > FRETS) return null;
      v[s] = abs;
    }
  }
  return v;
}

function voicingFromBarre(shape, barreFret){
  const v = {};
  for(const s of ALL_COLS){
    const o = shape.offs[s];
    if(o === null || o === undefined) v[s] = null;
    else{
      const f = barreFret + o;
      if(f < 0 || f > FRETS) return null;
      v[s] = f;
    }
  }
  return v;
}

function isPlayableCommon(voicing){
  const frets = [];
  let count = 0;
  for(const s of ALL_COLS){
    const f = voicing[s];
    if(f === null) continue;
    count++;
    frets.push(f);
  }
  if(count < 2) return false;
  const minF = Math.min(...frets);
  const maxF = Math.max(...frets);
  if(maxF - minF > 5) return false;
  if(minF > 17) return false;
  return true;
}

/* bass note of a voicing: lowest sounding MIDI */
function voicingLowestMidi(voicing){
  const tuning = currentTuning();
  let best = null;
  for(const s of ALL_COLS){
    const f = voicing[s];
    if(f === null) continue;
    const midi = tuning[s] + f;
    if(best === null || midi < best) best = midi;
  }
  return best;
}
function voicingBassPc(voicing){
  const m = voicingLowestMidi(voicing);
  return (m===null) ? null : mod(m,12);
}

/* power chord preference filtering */
function shapesForQuality(qid){
  if(qid !== "5") return BARRE.filter(s=>s.q===qid);

  if(powerRootPref === "6") return BARRE.filter(s=>s.q==="5" && s.rootString===6);
  if(powerRootPref === "5") return BARRE.filter(s=>s.q==="5" && s.rootString===5);
  // auto: allow both
  return BARRE.filter(s=>s.q==="5");
}

function generateCommonVoicings(rootPc, qid){
  if(instrument !== "guitar") return [];

  const tuning = currentTuning();
  const out = [];

  // open forms only for specific roots
  const rootName = pcToName(rootPc);
  const openKey = `${rootName}:${qid}`;
  if(OPEN_FORMS[openKey]){
    const v = voicingFromOpenForm(OPEN_FORMS[openKey]);
    if(v && isPlayableCommon(v)) out.push({voicing:v, tag:"open"});
  }

  // barre shapes
  const shapes = shapesForQuality(qid);
  for(const sh of shapes){
    const rs = sh.rootString;
    const openMidi = tuning[rs];
    for(let bf=0; bf<=FRETS; bf++){
      const pc = mod(openMidi + bf, 12);
      if(pc !== rootPc) continue;
      const v = voicingFromBarre(sh, bf);
      if(!v) continue;
      if(!isPlayableCommon(v)) continue;
      out.push({voicing:v, tag:`barre-${sh.family}`});
    }
  }

  // de-dup
  const seen = new Set();
  const uniq = [];
  for(const r of out){
    const sig = ALL_COLS.map(s=> (r.voicing[s]===null?"x":r.voicing[s])).join("-");
    if(seen.has(sig)) continue;
    seen.add(sig);
    uniq.push(r);
  }

  // sort by min fret
  uniq.sort((a,b)=>{
    const ma = Math.min(...ALL_COLS.map(s=>a.voicing[s]).filter(x=>x!==null));
    const mb = Math.min(...ALL_COLS.map(s=>b.voicing[s]).filter(x=>x!==null));
    return ma-mb;
  });

  return uniq;
}

function pickPreferredVoicing(voicings){
  if(!voicings.length) return null;
  if(voicingPref === "open"){
    const open = voicings.find(v=>v.tag==="open");
    return open || voicings[0];
  }
  if(voicingPref === "barreE"){
    const e = voicings.find(v=>v.tag==="barre-E");
    return e || voicings[0];
  }
  if(voicingPref === "barreA"){
    const a = voicings.find(v=>v.tag==="barre-A");
    return a || voicings[0];
  }
  return voicings[0];
}

function applyVoicing(voicing){
  ALL_COLS.forEach(s => selectedByString.set(s, null));
  document.querySelectorAll('.cell.selected').forEach(el=>el.classList.remove('selected'));
  if(!voicing){ updateUI(); return; }

  for(const s of ALL_COLS){
    const f = voicing[s];
    if(f === null) continue;
    selectedByString.set(s, f);
    const cell = document.querySelector(`.cell[data-string="${s}"][data-fret="${f}"]`);
    if(cell){
      cell.classList.add('selected');
      pulseCell(cell);
    }
  }
  updateUI();
}

/* Bass modes: chord click sets root only on chosen follow string */
function applyBassRootOnly(rootPc){
  ALL_COLS.forEach(s => selectedByString.set(s, null));
  document.querySelectorAll('.cell.selected').forEach(el=>el.classList.remove('selected'));

  const tuning = currentTuning();
  const s = bassFollowString;
  if(!activeStrings.includes(s)) return;

  const openPc = mod(tuning[s], 12);
  let f = mod(rootPc - openPc, 12);
  if(f + 12 <= FRETS && f <= 2) f += 12;
  if(f > FRETS) f = 0;

  selectedByString.set(s, f);
  const cell = document.querySelector(`.cell[data-string="${s}"][data-fret="${f}"]`);
  if(cell){
    cell.classList.add('selected');
    pulseCell(cell);
  }
  updateUI();
}

/* ---------------- chord list UI ---------------- */
const ROOTS = NOTE_NAMES.slice();
let allChordItems = []; // {rootPc,qid,voicings (guitar only)}

function buildQualityFilter(){
  const sel = document.getElementById('qualitySel');
  sel.innerHTML = `<option value="all">すべて</option>`;
  QUALITIES.forEach(q=>{
    const opt = document.createElement('option');
    opt.value = q.id;
    opt.textContent = q.id;
    sel.appendChild(opt);
  });
}

function buildBassNoteSel(){
  const sel = document.getElementById('bassNoteSel');
  sel.innerHTML = "";
  ROOTS.forEach(n=>{
    const opt = document.createElement('option');
    opt.value = n;
    opt.textContent = n;
    sel.appendChild(opt);
  });
  sel.value = "E";
  slashBassPc = nameToPc("E");
  sel.addEventListener('change', ()=>{
    slashBassPc = nameToPc(sel.value);
    renderChordGrid();
  });
}

function buildBassFollowSel(){
  const sel = document.getElementById('bassFollowSel');
  sel.innerHTML = "";
  // will be populated per instrument
}

function repopulateBassFollowSel(){
  const sel = document.getElementById('bassFollowSel');
  sel.innerHTML = "";
  const strings = [...activeStrings].sort((a,b)=>b-a); // 低い方(番号大)から
  for(const s of strings){
    const opt = document.createElement('option');
    opt.value = String(s);
    opt.textContent = `${s}弦でルート`;
    sel.appendChild(opt);
  }
  // default to lowest physical string (max number) but user can change
  bassFollowString = strings[0];
  sel.value = String(bassFollowString);
  sel.onchange = ()=>{
    bassFollowString = Number(sel.value);
  };
}

function rebuildChordInventory(){
  allChordItems = [];
  for(const q of QUALITIES){
    for(let r=0;r<12;r++){
      if(instrument === "guitar"){
        const voicings = generateCommonVoicings(r, q.id);
        if(!voicings.length) continue;
        allChordItems.push({rootPc:r, qid:q.id, voicings});
      }else{
        // bass: hide those not playable in guitar common shapes
        const savedInst = instrument, savedBase = baseTuning, savedCapo = capo, savedActive = activeStrings, savedPref = powerRootPref;
        instrument = "guitar";
        baseTuning = structuredClone(GUITAR_6);
        activeStrings = [6,5,4,3,2,1];
        capo = 0;
        powerRootPref = "auto";
        const voicings = generateCommonVoicings(r, q.id);
        instrument = savedInst; baseTuning = savedBase; capo = savedCapo; activeStrings = savedActive; powerRootPref = savedPref;

        if(!voicings.length) continue;
        allChordItems.push({rootPc:r, qid:q.id, voicings:[]});
      }
    }
  }
}

function passesSearch(item, q){
  if(!q) return true;
  const s = q.toLowerCase().replace(/\s+/g,"");
  const name = chordName(item.rootPc, item.qid).toLowerCase().replace(/\s+/g,"");
  const base = (pcToName(item.rootPc) + qualityLabel(item.qid)).toLowerCase().replace(/\s+/g,"");
  const slash = `${name}/${pcToName(slashBassPc)}`.toLowerCase().replace(/\s+/g,"");
  return name.includes(s) || base.includes(s) || slash.includes(s);
}

function renderChordGrid(){
  const grid = document.getElementById('chordGrid');
  grid.innerHTML = "";

  const qText = document.getElementById('searchBox').value.trim();
  const qFilter = document.getElementById('qualitySel').value;

  let items = allChordItems
    .filter(it => (qFilter==="all" ? true : it.qid===qFilter))
    .filter(it => passesSearch(it, qText))
    .sort((a,b)=> chordName(a.rootPc,a.qid).localeCompare(chordName(b.rootPc,b.qid)));

  // Slash mode: guitar only. Show only if at least one voicing exists; label ok/ng per button.
  // Also: in slash mode, button click chooses first "bass ok" voicing if possible, else first and mark NG.
  for(const it of items){
    const btn = document.createElement('button');
    btn.className = 'cbtn';
    btn.type = 'button';

    const baseName = chordName(it.rootPc, it.qid);

    if(slashMode && instrument === "guitar"){
      const wanted = slashBassPc;
      const okVoicing = it.voicings.find(v => voicingBassPc(v.voicing) === wanted);
      const isOk = !!okVoicing;

      btn.innerHTML = `${baseName}/${pcToName(wanted)} <span class="badge ${isOk?'ok':'ng'}">bass ${isOk?'ok':'NG'}</span>`;

      btn.addEventListener('click', ()=>{
        const picked = okVoicing || pickPreferredVoicing(it.voicings);
        applyVoicing(picked ? picked.voicing : null);
      });
    }else{
      btn.textContent = baseName;
      btn.addEventListener('click', ()=>{
        if(instrument === "guitar"){
          const v = pickPreferredVoicing(it.voicings);
          applyVoicing(v ? v.voicing : null);
        }else{
          applyBassRootOnly(it.rootPc);
        }
      });
    }

    btn.addEventListener('dblclick', ()=>{
      document.getElementById('btnClear').click();
    });

    // In slash mode, optionally hide chords with no OK voicing
    // → 今は「一覧に出してNGも見える」仕様（要望のラベル表示が目的）
    grid.appendChild(btn);
  }
}

/* ---------------- instrument switching ---------------- */
function setInstrument(val){
  instrument = val;
  if(instrument==="guitar"){
    baseTuning = structuredClone(GUITAR_6);
    activeStrings = [6,5,4,3,2,1];
  }else if(instrument==="bass4"){
    baseTuning = structuredClone(BASS_4);
    activeStrings = [4,3,2,1];
    capo = 0;
    document.getElementById('capoSel').value = "0";
  }else if(instrument==="bass5"){
    baseTuning = structuredClone(BASS_5);
    activeStrings = [5,4,3,2,1];
    capo = 0;
    document.getElementById('capoSel').value = "0";
  }else{
    baseTuning = structuredClone(BASS_6);
    activeStrings = [6,5,4,3,2,1];
    capo = 0;
    document.getElementById('capoSel').value = "0";
  }

  document.getElementById('btnClear').click();

  // enable/disable relevant controls
  const capoSel = document.getElementById('capoSel');
  const voiceSel = document.getElementById('voicingSel');
  const slashToggle = document.getElementById('slashMode');
  const bassNoteSel = document.getElementById('bassNoteSel');
  const bassFollowSel = document.getElementById('bassFollowSel');
  const powerSel = document.getElementById('powerRootSel');

  if(instrument !== "guitar"){
    capoSel.disabled = true;
    voiceSel.disabled = true;
    slashToggle.disabled = true;
    bassNoteSel.style.display = "none";
    powerSel.disabled = true;

    bassFollowSel.style.display = "inline-block";
    repopulateBassFollowSel();
  }else{
    capoSel.disabled = false;
    voiceSel.disabled = false;
    slashToggle.disabled = false;
    powerSel.disabled = false;

    bassFollowSel.style.display = "none";
    if(slashMode) bassNoteSel.style.display = "inline-block";
  }

  rebuildChordInventory();
  renderChordGrid();
  updateUI();
}

/* ---------------- events ---------------- */
document.getElementById('instSel').addEventListener('change', (e)=>setInstrument(e.target.value));
document.getElementById('tuneSel').addEventListener('change', (e)=>{
  tuneOffset = Number(e.target.value);
  rebuildChordInventory();
  renderChordGrid();
  updateUI();
});
document.getElementById('capoSel').addEventListener('change', (e)=>{
  capo = Number(e.target.value);
  if(instrument!=="guitar"){
    capo = 0;
    e.target.value = "0";
  }
  rebuildChordInventory();
  renderChordGrid();
  updateUI();
});
document.getElementById('voicingSel').addEventListener('change', (e)=>{
  voicingPref = e.target.value;
});

document.getElementById('powerRootSel').addEventListener('change', (e)=>{
  powerRootPref = e.target.value; // auto | 6 | 5
  rebuildChordInventory();
  renderChordGrid();
});

document.getElementById('searchBox').addEventListener('input', renderChordGrid);
document.getElementById('qualitySel').addEventListener('change', renderChordGrid);

document.getElementById('slashMode').addEventListener('change', (e)=>{
  slashMode = e.target.checked;
  const sel = document.getElementById('bassNoteSel');
  if(slashMode && instrument==="guitar"){
    sel.style.display = "inline-block";
  }else{
    sel.style.display = "none";
  }
  renderChordGrid();
});

/* ---------------- init ---------------- */
buildPiano();
buildQualityFilter();
buildBassNoteSel();
buildBassFollowSel();
setInstrument("guitar");
updateUI();
</script>
</body>
</html>
"""

@app.route("/")
def home():
    return render_template_string(
        HTML,
        NOTE_NAMES=NOTE_NAMES,
        black_pcs=sorted(list(BLACK_PCS)),
        MIN_MIDI=MIN_MIDI,
        MAX_MIDI=MAX_MIDI,
        FRETS=FRETS,
        guitar6=GUITAR_6,
        bass4=BASS_4,
        bass5=BASS_5,
        bass6=BASS_6
    )

if __name__ == "__main__":
    app.run(debug=True)
